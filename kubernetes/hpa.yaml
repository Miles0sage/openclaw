apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: openclaw-gateway-hpa
  namespace: openclaw
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: openclaw-gateway

  # Pod count limits
  minReplicas: 2 # Minimum for HA
  maxReplicas: 10 # Maximum scale-out

  # Scaling metrics
  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70 # Scale up at 70% CPU

    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80 # Scale up at 80% memory

  # Scaling behavior
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        # Scale up by adding pods linearly
        - type: Pods
          value: 2 # Add 2 pods
          periodSeconds: 60
        # Scale up by 50% max
        - type: Percent
          value: 50
          periodSeconds: 60
      selectPolicy: Max

    scaleDown:
      stabilizationWindowSeconds: 300 # Wait 5 minutes before scaling down
      policies:
        # Remove 1 pod at a time
        - type: Pods
          value: 1
          periodSeconds: 60
      selectPolicy: Min

---
# Optional: KEDA for custom metrics scaling
# Uncomment if you want to scale based on queue depth or other metrics
# apiVersion: keda.sh/v1alpha1
# kind: ScaledObject
# metadata:
#   name: openclaw-gateway-queue
#   namespace: openclaw
# spec:
#   scaleTargetRef:
#     name: openclaw-gateway
#   minReplicaCount: 2
#   maxReplicaCount: 10
#   triggers:
#     - type: external
#       metadata:
#         scalerAddress: external-scaler:6379
#         metricName: queue_depth
