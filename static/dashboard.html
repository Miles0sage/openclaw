<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenClaw Monitoring Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --surface2: #21262d;
        --border: #30363d;
        --text: #e6edf3;
        --text2: #8b949e;
        --text3: #484f58;
        --green: #3fb950;
        --green-bg: rgba(63, 185, 80, 0.15);
        --yellow: #d29922;
        --yellow-bg: rgba(210, 153, 34, 0.15);
        --red: #f85149;
        --red-bg: rgba(248, 81, 73, 0.15);
        --blue: #58a6ff;
        --blue-bg: rgba(88, 166, 255, 0.15);
        --purple: #bc8cff;
        --purple-bg: rgba(188, 140, 255, 0.15);
        --orange: #f0883e;
        --accent: #58a6ff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }

      /* Header */
      .header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .logo span {
        color: var(--accent);
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .status-dot.ok {
        background: var(--green);
        box-shadow: 0 0 8px var(--green);
      }
      .status-dot.warn {
        background: var(--yellow);
        box-shadow: 0 0 8px var(--yellow);
      }
      .status-dot.err {
        background: var(--red);
        box-shadow: 0 0 8px var(--red);
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: var(--text2);
      }
      .auth-input {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 10px;
        color: var(--text);
        font-size: 12px;
        width: 200px;
        font-family: monospace;
      }
      .auth-input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .refresh-btn {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 12px;
        color: var(--text);
        cursor: pointer;
        font-size: 12px;
      }
      .refresh-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0 24px;
        overflow-x: auto;
      }
      .tab {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text2);
        border-bottom: 2px solid transparent;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .tab:hover {
        color: var(--text);
      }
      .tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      /* Layout */
      .content {
        padding: 20px 24px;
        max-width: 1400px;
        margin: 0 auto;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      .grid-4 {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      }

      /* Cards */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        transition: border-color 0.15s;
      }
      .card:hover {
        border-color: var(--text3);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .card-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .card-value {
        font-size: 28px;
        font-weight: 700;
        margin: 4px 0;
      }
      .card-sub {
        font-size: 12px;
        color: var(--text2);
      }

      /* Stat cards */
      .stat-card {
        position: relative;
        overflow: hidden;
      }
      .stat-card .icon {
        position: absolute;
        right: 12px;
        top: 12px;
        font-size: 32px;
        opacity: 0.15;
      }
      .stat-card.green .card-value {
        color: var(--green);
      }
      .stat-card.blue .card-value {
        color: var(--accent);
      }
      .stat-card.yellow .card-value {
        color: var(--yellow);
      }
      .stat-card.red .card-value {
        color: var(--red);
      }
      .stat-card.purple .card-value {
        color: var(--purple);
      }

      /* Badge */
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-green {
        background: var(--green-bg);
        color: var(--green);
      }
      .badge-yellow {
        background: var(--yellow-bg);
        color: var(--yellow);
      }
      .badge-red {
        background: var(--red-bg);
        color: var(--red);
      }
      .badge-blue {
        background: var(--blue-bg);
        color: var(--blue);
      }
      .badge-purple {
        background: var(--purple-bg);
        color: var(--purple);
      }

      /* Table */
      .table-wrap {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th {
        text-align: left;
        padding: 8px 12px;
        color: var(--text2);
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }
      td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }
      tr:hover td {
        background: var(--surface2);
      }

      /* Progress bar */
      .progress-bar {
        height: 6px;
        background: var(--surface2);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 6px;
      }
      .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
      }
      .progress-fill.green {
        background: var(--green);
      }
      .progress-fill.yellow {
        background: var(--yellow);
      }
      .progress-fill.red {
        background: var(--red);
      }

      /* Chart (simple bar chart in CSS) */
      .chart-bar-group {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 120px;
        padding: 8px 0;
      }
      .chart-bar {
        flex: 1;
        min-width: 24px;
        max-width: 60px;
        border-radius: 4px 4px 0 0;
        position: relative;
        transition: height 0.5s ease;
        cursor: pointer;
      }
      .chart-bar:hover {
        opacity: 0.8;
      }
      .chart-bar .label {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: var(--text2);
        white-space: nowrap;
      }
      .chart-bar .val {
        position: absolute;
        top: -18px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: var(--text);
        white-space: nowrap;
      }

      /* Agent card */
      .agent-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
      }
      .agent-avatar {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        color: white;
      }
      .agent-info {
        flex: 1;
      }
      .agent-name {
        font-weight: 600;
        font-size: 14px;
      }
      .agent-meta {
        font-size: 12px;
        color: var(--text2);
        margin-top: 2px;
      }

      /* Event log */
      .event-item {
        display: flex;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
      }
      .event-time {
        color: var(--text2);
        font-size: 11px;
        white-space: nowrap;
        min-width: 80px;
      }
      .event-type {
        font-weight: 600;
      }
      .event-detail {
        color: var(--text2);
        margin-top: 2px;
        font-size: 12px;
      }

      /* Panel visibility */
      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }

      /* Spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 13px;
        z-index: 200;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          flex-wrap: wrap;
          gap: 8px;
        }
        .auth-input {
          width: 140px;
        }
        .grid-4 {
          grid-template-columns: repeat(2, 1fr);
        }
        .content {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo"><span>Open</span>Claw</div>
        <span id="systemStatus"><span class="status-dot ok"></span>Operational</span>
      </div>
      <div class="header-right">
        <span id="lastRefresh">--</span>
        <input
          type="text"
          class="auth-input"
          id="authToken"
          placeholder="Auth token (for protected endpoints)"
        />
        <button class="refresh-btn" onclick="refreshAll()">Refresh</button>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px">
          <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()" /> Auto 30s
        </label>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-panel="overview">Overview</div>
      <div class="tab" data-panel="agents">Agents</div>
      <div class="tab" data-panel="costs">Costs</div>
      <div class="tab" data-panel="jobs">Jobs</div>
      <div class="tab" data-panel="proposals">Proposals</div>
      <div class="tab" data-panel="events">Events</div>
      <div class="tab" data-panel="system">System</div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- OVERVIEW PANEL -->
      <div class="panel active" id="panel-overview">
        <div class="grid grid-4" style="margin-bottom: 16px" id="statCards">
          <!-- filled by JS -->
        </div>
        <div class="grid grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">Cost by Model</span></div>
            <div id="costByModelChart" class="chart-bar-group"></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Cost by Agent</span></div>
            <div id="costByAgentChart" class="chart-bar-group"></div>
          </div>
        </div>
        <div class="grid grid-2" style="margin-top: 16px">
          <div class="card">
            <div class="card-header"><span class="card-title">Recent Events</span></div>
            <div id="recentEvents">Loading...</div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Agent Status</span></div>
            <div id="agentStatusOverview">Loading...</div>
          </div>
        </div>
      </div>

      <!-- AGENTS PANEL -->
      <div class="panel" id="panel-agents">
        <div class="grid grid-2" id="agentCards">Loading...</div>
      </div>

      <!-- COSTS PANEL -->
      <div class="panel" id="panel-costs">
        <div class="grid grid-4" style="margin-bottom: 16px" id="costStatCards"></div>
        <div class="grid grid-2" style="margin-bottom: 16px">
          <div class="card">
            <div class="card-header"><span class="card-title">Cost by Model</span></div>
            <div id="costModelChartFull" class="chart-bar-group" style="height: 160px"></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Cost by Project</span></div>
            <div id="costProjectChartFull" class="chart-bar-group" style="height: 160px"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Budget Status</span></div>
          <div id="budgetStatus">Loading...</div>
        </div>
      </div>

      <!-- JOBS PANEL -->
      <div class="panel" id="panel-jobs">
        <div class="card">
          <div class="card-header">
            <span class="card-title">All Jobs</span><span class="card-sub" id="jobCount"></span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Project</th>
                  <th>Task</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody id="jobsTable">
                <tr>
                  <td colspan="6">Loading... (requires auth token)</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PROPOSALS PANEL -->
      <div class="panel" id="panel-proposals">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Proposals</span
            ><span class="card-sub" id="proposalCount"></span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Agent</th>
                  <th>Est Cost</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody id="proposalsTable">
                <tr>
                  <td colspan="6">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EVENTS PANEL -->
      <div class="panel" id="panel-events">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Event Log</span><span class="card-sub" id="eventCount"></span>
          </div>
          <div id="eventLog">Loading...</div>
        </div>
      </div>

      <!-- SYSTEM PANEL -->
      <div class="panel" id="panel-system">
        <div class="grid grid-3" style="margin-bottom: 16px">
          <div class="card">
            <div class="card-header"><span class="card-title">Heartbeat Monitor</span></div>
            <div id="heartbeatInfo">Loading...</div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Router Health</span></div>
            <div id="routerInfo">Loading...</div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Approval Policy</span></div>
            <div id="policyInfo">Loading...</div>
          </div>
        </div>
        <div class="grid grid-2" style="margin-bottom: 16px">
          <div class="card">
            <div class="card-header"><span class="card-title">Cron Jobs</span></div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Schedule</th>
                    <th>Enabled</th>
                    <th>Runs</th>
                    <th>Last Run</th>
                  </tr>
                </thead>
                <tbody id="cronTable">
                  <tr>
                    <td colspan="5">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">Memories</span
              ><span class="card-sub" id="memoryCount"></span>
            </div>
            <div id="memoryList">Loading...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Quota Status</span></div>
          <div id="quotaDetail">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
      // ============================================================
      // State
      // ============================================================
      let refreshTimer = null;
      const STATE = {
        health: null,
        agents: null,
        costs: null,
        jobs: null,
        proposals: null,
        events: null,
        memories: null,
        cron: null,
        heartbeat: null,
        quotas: null,
        router: null,
        policy: null,
      };

      // ============================================================
      // Helpers
      // ============================================================
      function getToken() {
        return document.getElementById("authToken").value.trim();
      }

      async function api(path) {
        const headers = { Accept: "application/json" };
        const token = getToken();
        if (token) headers["X-Auth-Token"] = token;
        try {
          const r = await fetch(path, { headers });
          if (!r.ok) {
            if (r.status === 401) return { _error: "unauthorized" };
            return { _error: r.status };
          }
          return await r.json();
        } catch (e) {
          return { _error: e.message };
        }
      }

      function fmt$(v) {
        return "$" + Number(v || 0).toFixed(4);
      }
      function fmtDate(s) {
        if (!s) return "--";
        const d = new Date(s);
        return (
          d.toLocaleDateString("en-US", { month: "short", day: "numeric" }) +
          " " +
          d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" })
        );
      }
      function shortId(s) {
        return s ? s.slice(-8) : "--";
      }
      function statusBadge(s) {
        const map = {
          done: "green",
          completed: "green",
          approved: "green",
          idle: "green",
          running: "blue",
          active: "blue",
          pending: "yellow",
          pr_ready: "purple",
          failed: "red",
          rejected: "red",
          error: "red",
        };
        return `<span class="badge badge-${map[s] || "yellow"}">${s || "unknown"}</span>`;
      }
      function priorityBadge(p) {
        const map = { P0: "red", P1: "yellow", P2: "blue", P3: "green" };
        return `<span class="badge badge-${map[p] || "blue"}">${p || "--"}</span>`;
      }

      function toast(msg, dur = 3000) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), dur);
      }

      const COLORS = [
        "#58a6ff",
        "#3fb950",
        "#d29922",
        "#f85149",
        "#bc8cff",
        "#f0883e",
        "#79c0ff",
        "#7ee787",
      ];

      function renderBarChart(containerId, data, heightPx) {
        const el = document.getElementById(containerId);
        if (!el) return;
        const h = heightPx || 120;
        el.style.height = h + "px";
        if (!data || Object.keys(data).length === 0) {
          el.innerHTML = '<span style="color:var(--text2);font-size:12px">No data</span>';
          return;
        }
        const max = Math.max(...Object.values(data), 0.001);
        el.innerHTML = Object.entries(data)
          .map(([k, v], i) => {
            const pct = (v / max) * 100;
            const color = COLORS[i % COLORS.length];
            return `<div class="chart-bar" style="height:${Math.max(pct, 4)}%;background:${color}" title="${k}: ${fmt$(v)}">
      <span class="val">${fmt$(v)}</span>
      <span class="label">${k.replace(/-/g, " ").replace(/claude.*/, "claude")}</span>
    </div>`;
          })
          .join("");
      }

      // ============================================================
      // Tab switching
      // ============================================================
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          document.querySelectorAll(".panel").forEach((p) => p.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById("panel-" + tab.dataset.panel).classList.add("active");
        });
      });

      // ============================================================
      // Data fetching
      // ============================================================
      async function fetchAll() {
        const [
          health,
          agents,
          costs,
          quotas,
          proposals,
          events,
          memories,
          cron,
          heartbeat,
          router,
          policy,
          jobs,
        ] = await Promise.all([
          api("/health"),
          api("/api/agents"),
          api("/api/costs/summary"),
          api("/api/quotas/status"),
          api("/api/proposals"),
          api("/api/events"),
          api("/api/memories"),
          api("/api/cron/jobs"),
          api("/api/heartbeat/status"),
          api("/api/route/health"),
          api("/api/policy"),
          api("/api/jobs"),
        ]);
        STATE.health = health;
        STATE.agents = agents;
        STATE.costs = costs;
        STATE.quotas = quotas;
        STATE.proposals = proposals;
        STATE.events = events;
        STATE.memories = memories;
        STATE.cron = cron;
        STATE.heartbeat = heartbeat;
        STATE.router = router;
        STATE.policy = policy;
        STATE.jobs = jobs;
      }

      // ============================================================
      // Renderers
      // ============================================================
      function renderSystemStatus() {
        const el = document.getElementById("systemStatus");
        const h = STATE.health;
        if (!h || h._error) {
          el.innerHTML = '<span class="status-dot err"></span>Offline';
          return;
        }
        el.innerHTML = `<span class="status-dot ok"></span>${h.status || "Operational"} &middot; v${h.version || "?"} &middot; ${h.agents_active || 0} agents`;
      }

      function renderStatCards() {
        const el = document.getElementById("statCards");
        const costs = STATE.costs?.data || STATE.costs || {};
        const quotas = STATE.quotas?.data || STATE.quotas || {};
        const agents = STATE.agents?.agents || [];
        const jobs = STATE.jobs?.jobs || [];
        const proposals = STATE.proposals?.proposals || [];
        const events = STATE.events?.events || [];

        const activeJobs = jobs.filter(
          (j) => j.status === "running" || j.status === "active",
        ).length;
        const pendingProposals = proposals.filter((p) => p.status === "pending").length;
        const dailyPct = quotas.daily_percent || 0;

        el.innerHTML = `
    <div class="card stat-card green"><div class="icon">A</div>
      <div class="card-title">Agents</div>
      <div class="card-value">${agents.length}</div>
      <div class="card-sub">${agents.filter((a) => a.status === "idle").length} idle, ${agents.filter((a) => a.status !== "idle").length} busy</div>
    </div>
    <div class="card stat-card blue"><div class="icon">$</div>
      <div class="card-title">Total Cost</div>
      <div class="card-value">${fmt$(costs.total_cost)}</div>
      <div class="card-sub">${costs.entries_count || 0} API calls</div>
    </div>
    <div class="card stat-card ${pendingProposals > 0 ? "yellow" : "green"}"><div class="icon">P</div>
      <div class="card-title">Proposals</div>
      <div class="card-value">${pendingProposals}</div>
      <div class="card-sub">pending of ${proposals.length} total</div>
    </div>
    <div class="card stat-card ${dailyPct > 80 ? "red" : dailyPct > 50 ? "yellow" : "green"}"><div class="icon">Q</div>
      <div class="card-title">Daily Budget</div>
      <div class="card-value">${dailyPct.toFixed(1)}%</div>
      <div class="card-sub">${fmt$(quotas.daily_used)} / ${fmt$(quotas.daily_budget)}</div>
      <div class="progress-bar"><div class="progress-fill ${dailyPct > 80 ? "red" : dailyPct > 50 ? "yellow" : "green"}" style="width:${Math.min(dailyPct, 100)}%"></div></div>
    </div>
  `;
      }

      function renderOverviewCharts() {
        const costs = STATE.costs?.data || STATE.costs || {};
        renderBarChart("costByModelChart", costs.by_model);
        renderBarChart("costByAgentChart", costs.by_agent);
      }

      function renderRecentEvents() {
        const el = document.getElementById("recentEvents");
        const events = (STATE.events?.events || []).slice(0, 5);
        if (!events.length) {
          el.innerHTML =
            '<span style="color:var(--text2);font-size:13px">No events recorded</span>';
          return;
        }
        el.innerHTML = events
          .map(
            (e) => `
    <div class="event-item">
      <div class="event-time">${fmtDate(e.timestamp)}</div>
      <div>
        <div class="event-type">${e.event_type}</div>
        <div class="event-detail">${e.data?.title || e.data?.job_id || JSON.stringify(e.data).slice(0, 80)}</div>
      </div>
    </div>
  `,
          )
          .join("");
      }

      function renderAgentStatusOverview() {
        const el = document.getElementById("agentStatusOverview");
        const agents = STATE.agents?.agents || [];
        if (!agents.length) {
          el.innerHTML = '<span style="color:var(--text2)">No agents</span>';
          return;
        }
        el.innerHTML = agents
          .map((a) => {
            const colors = {
              coordinator: "#58a6ff",
              developer: "#3fb950",
              security: "#f85149",
              data_specialist: "#bc8cff",
            };
            const bg = colors[a.role] || "#58a6ff";
            return `<div class="agent-card" style="margin-bottom:8px">
      <div class="agent-avatar" style="background:${bg}">${a.name ? a.name[0] : "?"}</div>
      <div class="agent-info">
        <div class="agent-name">${a.name}</div>
        <div class="agent-meta">${a.model} &middot; ${a.provider}</div>
      </div>
      ${statusBadge(a.status)}
    </div>`;
          })
          .join("");
      }

      function renderAgentsPanel() {
        const el = document.getElementById("agentCards");
        const agents = STATE.agents?.agents || [];
        if (!agents.length) {
          el.innerHTML =
            '<div class="card"><span style="color:var(--text2)">No agents found</span></div>';
          return;
        }
        const colors = {
          coordinator: "#58a6ff",
          developer: "#3fb950",
          security: "#f85149",
          data_specialist: "#bc8cff",
        };
        el.innerHTML = agents
          .map((a) => {
            const bg = colors[a.role] || "#58a6ff";
            return `<div class="card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div class="agent-avatar" style="background:${bg};font-size:22px;width:48px;height:48px">${a.name ? a.name[0] : "?"}</div>
        <div>
          <div style="font-size:16px;font-weight:700">${a.name}</div>
          <div style="font-size:12px;color:var(--text2)">${a.id}</div>
        </div>
        <div style="margin-left:auto">${statusBadge(a.status)}</div>
      </div>
      <table>
        <tr><td style="color:var(--text2);width:100px">Provider</td><td>${a.provider}</td></tr>
        <tr><td style="color:var(--text2)">Model</td><td><code>${a.model}</code></td></tr>
        <tr><td style="color:var(--text2)">Role</td><td>${a.role}</td></tr>
      </table>
    </div>`;
          })
          .join("");
      }

      function renderCostsPanel() {
        const costs = STATE.costs?.data || STATE.costs || {};
        const quotas = STATE.quotas?.data || STATE.quotas || {};

        // Stat cards
        const el = document.getElementById("costStatCards");
        const dailyPct = quotas.daily_percent || 0;
        const monthlyPct = quotas.monthly_percent || 0;
        el.innerHTML = `
    <div class="card stat-card blue"><div class="card-title">Total Spend</div><div class="card-value">${fmt$(costs.total_cost)}</div><div class="card-sub">${costs.entries_count || 0} API calls</div></div>
    <div class="card stat-card ${dailyPct > 80 ? "red" : "green"}"><div class="card-title">Daily</div><div class="card-value">${fmt$(quotas.daily_used)}</div><div class="card-sub">of ${fmt$(quotas.daily_budget)} budget</div>
      <div class="progress-bar"><div class="progress-fill ${dailyPct > 80 ? "red" : dailyPct > 50 ? "yellow" : "green"}" style="width:${Math.min(dailyPct, 100)}%"></div></div></div>
    <div class="card stat-card ${monthlyPct > 80 ? "red" : "green"}"><div class="card-title">Monthly</div><div class="card-value">${fmt$(quotas.monthly_used)}</div><div class="card-sub">of ${fmt$(quotas.monthly_budget)} budget</div>
      <div class="progress-bar"><div class="progress-fill ${monthlyPct > 80 ? "red" : monthlyPct > 50 ? "yellow" : "green"}" style="width:${Math.min(monthlyPct, 100)}%"></div></div></div>
    <div class="card stat-card green"><div class="card-title">Status</div><div class="card-value" style="font-size:18px">${quotas.status || "--"}</div><div class="card-sub">Quotas ${quotas.quotas_enabled ? "enabled" : "disabled"}</div></div>
  `;

        // Charts
        renderBarChart("costModelChartFull", costs.by_model, 160);
        renderBarChart("costProjectChartFull", costs.by_project, 160);

        // Budget detail
        const budgetEl = document.getElementById("budgetStatus");
        if (costs.timestamp_range) {
          budgetEl.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px">
        <div><span style="color:var(--text2)">First entry:</span> ${fmtDate(costs.timestamp_range.first)}</div>
        <div><span style="color:var(--text2)">Last entry:</span> ${fmtDate(costs.timestamp_range.last)}</div>
        <div><span style="color:var(--text2)">Daily remaining:</span> <strong style="color:var(--green)">${fmt$(quotas.daily_remaining)}</strong></div>
        <div><span style="color:var(--text2)">Monthly remaining:</span> <strong style="color:var(--green)">${fmt$(quotas.monthly_remaining)}</strong></div>
        <div><span style="color:var(--text2)">Warning at:</span> ${quotas.warning_threshold_percent || 80}%</div>
        <div><span style="color:var(--text2)">Models used:</span> ${Object.keys(costs.by_model || {}).length}</div>
      </div>
    `;
        } else {
          budgetEl.innerHTML = '<span style="color:var(--text2)">No cost data yet</span>';
        }
      }

      function renderJobsPanel() {
        const el = document.getElementById("jobsTable");
        const jobs = STATE.jobs?.jobs;
        const countEl = document.getElementById("jobCount");

        if (!jobs || STATE.jobs?._error === "unauthorized") {
          el.innerHTML =
            '<tr><td colspan="6" style="color:var(--yellow)">Enter auth token above to view jobs</td></tr>';
          return;
        }
        countEl.textContent = `${jobs.length} total`;
        if (!jobs.length) {
          el.innerHTML = '<tr><td colspan="6" style="color:var(--text2)">No jobs</td></tr>';
          return;
        }

        el.innerHTML = jobs
          .map(
            (j) => `<tr>
    <td><code>${shortId(j.id)}</code></td>
    <td>${j.project || "--"}</td>
    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(j.task || "").replace(/"/g, "&quot;")}">${j.task || "--"}</td>
    <td>${priorityBadge(j.priority)}</td>
    <td>${statusBadge(j.status)}</td>
    <td style="white-space:nowrap">${fmtDate(j.created_at)}</td>
  </tr>`,
          )
          .join("");
      }

      function renderProposalsPanel() {
        const el = document.getElementById("proposalsTable");
        const proposals = STATE.proposals?.proposals || [];
        const countEl = document.getElementById("proposalCount");
        countEl.textContent = `${proposals.length} total`;

        if (!proposals.length) {
          el.innerHTML = '<tr><td colspan="6" style="color:var(--text2)">No proposals</td></tr>';
          return;
        }

        el.innerHTML = proposals
          .map(
            (p) => `<tr>
    <td><code>${shortId(p.id)}</code></td>
    <td>${p.title || "--"}</td>
    <td>${p.agent_pref || "--"}</td>
    <td>${fmt$(p.cost_est_usd)}</td>
    <td>${statusBadge(p.status)}</td>
    <td style="white-space:nowrap">${fmtDate(p.created_at)}</td>
  </tr>`,
          )
          .join("");
      }

      function renderEventsPanel() {
        const el = document.getElementById("eventLog");
        const events = STATE.events?.events || [];
        const countEl = document.getElementById("eventCount");
        countEl.textContent = `${events.length} total`;

        if (!events.length) {
          el.innerHTML = '<span style="color:var(--text2)">No events</span>';
          return;
        }

        el.innerHTML = events
          .map((e) => {
            const typeColors = {
              "proposal.created": "blue",
              "job.created": "green",
              "job.completed": "green",
              "job.failed": "red",
              "agent.error": "red",
            };
            const color = typeColors[e.event_type] || "yellow";
            return `<div class="event-item">
      <div class="event-time">${fmtDate(e.timestamp)}</div>
      <div style="flex:1">
        <div><span class="badge badge-${color}">${e.event_type}</span></div>
        <div class="event-detail">${e.data?.title || e.data?.description || e.data?.job_id || JSON.stringify(e.data).slice(0, 120)}</div>
      </div>
    </div>`;
          })
          .join("");
      }

      function renderSystemPanel() {
        // Heartbeat
        const hbEl = document.getElementById("heartbeatInfo");
        const hb = STATE.heartbeat;
        if (hb && !hb._error) {
          const m = hb.monitor || {};
          hbEl.innerHTML = `
      <div style="margin-bottom:8px">${statusBadge(hb.status)}</div>
      <table>
        <tr><td style="color:var(--text2)">Running</td><td>${m.running ? "Yes" : "No"}</td></tr>
        <tr><td style="color:var(--text2)">Agents Monitored</td><td>${m.agents_monitoring || 0}</td></tr>
        <tr><td style="color:var(--text2)">Check Interval</td><td>${(m.config?.check_interval_ms || 0) / 1000}s</td></tr>
        <tr><td style="color:var(--text2)">Stale Threshold</td><td>${(m.config?.stale_threshold_ms || 0) / 1000}s</td></tr>
        <tr><td style="color:var(--text2)">Timeout</td><td>${(m.config?.timeout_threshold_ms || 0) / 1000}s</td></tr>
      </table>
    `;
        } else {
          hbEl.innerHTML = '<span style="color:var(--text2)">Unavailable</span>';
        }

        // Router
        const rtEl = document.getElementById("routerInfo");
        const rt = STATE.router;
        if (rt && !rt._error) {
          rtEl.innerHTML = `
      <div style="margin-bottom:8px">${statusBadge(rt.status)}</div>
      <table>
        <tr><td style="color:var(--text2)">Version</td><td>${rt.router_version || "--"}</td></tr>
        <tr><td style="color:var(--text2)">Models</td><td>${(rt.models || []).join(", ")}</td></tr>
        <tr><td style="color:var(--text2)">Count</td><td>${rt.models_available || 0}</td></tr>
      </table>
    `;
        } else {
          rtEl.innerHTML = '<span style="color:var(--text2)">Unavailable</span>';
        }

        // Policy
        const plEl = document.getElementById("policyInfo");
        const rules = STATE.policy?.rules || [];
        if (rules.length) {
          plEl.innerHTML = rules
            .map(
              (r) => `
      <div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:13px">
        <strong>${r.name}</strong>
        <span class="badge badge-${r.action === "approve" ? "green" : r.action === "require_human" ? "yellow" : "red"}" style="margin-left:8px">${r.action}</span>
        ${r.max_cost_usd ? `<span style="color:var(--text2);margin-left:8px">max ${fmt$(r.max_cost_usd)}</span>` : ""}
      </div>
    `,
            )
            .join("");
        } else {
          plEl.innerHTML = '<span style="color:var(--text2)">No policies</span>';
        }

        // Cron
        const cronEl = document.getElementById("cronTable");
        const cronJobs = STATE.cron?.jobs || [];
        if (cronJobs.length) {
          cronEl.innerHTML = cronJobs
            .map(
              (c) => `<tr>
      <td><strong>${c.name}</strong></td>
      <td><code>${c.cron_expr}</code></td>
      <td>${c.enabled ? '<span class="badge badge-green">ON</span>' : '<span class="badge badge-red">OFF</span>'}</td>
      <td>${c.run_count || 0}</td>
      <td>${fmtDate(c.last_run)}</td>
    </tr>`,
            )
            .join("");
        } else {
          cronEl.innerHTML =
            '<tr><td colspan="5" style="color:var(--text2)">No cron jobs</td></tr>';
        }

        // Memories
        const memEl = document.getElementById("memoryList");
        const memories = STATE.memories?.memories || [];
        const memCountEl = document.getElementById("memoryCount");
        memCountEl.textContent = `${memories.length} stored`;
        if (memories.length) {
          memEl.innerHTML = memories
            .slice(0, 15)
            .map(
              (m) => `
      <div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span>${m.content.slice(0, 100)}</span>
          <span class="badge badge-blue">${m.importance || 0}</span>
        </div>
        <div style="color:var(--text2);font-size:11px;margin-top:2px">${(m.tags || []).join(", ")} &middot; ${m.source} &middot; ${fmtDate(m.created_at)}</div>
      </div>
    `,
            )
            .join("");
        } else {
          memEl.innerHTML = '<span style="color:var(--text2)">No memories stored</span>';
        }

        // Quota detail
        const qEl = document.getElementById("quotaDetail");
        const q = STATE.quotas?.data || STATE.quotas || {};
        qEl.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px">
      <div>
        <div style="color:var(--text2);font-size:12px;margin-bottom:4px">Daily Budget</div>
        <div style="font-size:20px;font-weight:700">${fmt$(q.daily_used)} <span style="color:var(--text2);font-size:14px">/ ${fmt$(q.daily_budget)}</span></div>
        <div class="progress-bar" style="margin-top:8px"><div class="progress-fill ${(q.daily_percent || 0) > 80 ? "red" : "green"}" style="width:${Math.min(q.daily_percent || 0, 100)}%"></div></div>
      </div>
      <div>
        <div style="color:var(--text2);font-size:12px;margin-bottom:4px">Monthly Budget</div>
        <div style="font-size:20px;font-weight:700">${fmt$(q.monthly_used)} <span style="color:var(--text2);font-size:14px">/ ${fmt$(q.monthly_budget)}</span></div>
        <div class="progress-bar" style="margin-top:8px"><div class="progress-fill ${(q.monthly_percent || 0) > 80 ? "red" : "green"}" style="width:${Math.min(q.monthly_percent || 0, 100)}%"></div></div>
      </div>
    </div>
  `;
      }

      // ============================================================
      // Main render
      // ============================================================
      async function refreshAll() {
        document.getElementById("lastRefresh").innerHTML = '<span class="spinner"></span>';
        try {
          await fetchAll();
          renderSystemStatus();
          renderStatCards();
          renderOverviewCharts();
          renderRecentEvents();
          renderAgentStatusOverview();
          renderAgentsPanel();
          renderCostsPanel();
          renderJobsPanel();
          renderProposalsPanel();
          renderEventsPanel();
          renderSystemPanel();
          document.getElementById("lastRefresh").textContent =
            "Updated " + new Date().toLocaleTimeString();
          toast("Dashboard refreshed");
        } catch (e) {
          document.getElementById("lastRefresh").textContent = "Error: " + e.message;
          toast("Refresh failed: " + e.message);
        }
      }

      function toggleAutoRefresh() {
        if (document.getElementById("autoRefresh").checked) {
          refreshTimer = setInterval(refreshAll, 30000);
        } else {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
      }

      // Init
      refreshAll();
      refreshTimer = setInterval(refreshAll, 30000);
    </script>
  </body>
</html>
