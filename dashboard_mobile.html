<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="OpenClaw" />
    <title>OpenClaw Dashboard</title>
    <style>
      :root {
        --primary-color: #2563eb;
        --success-color: #16a34a;
        --warning-color: #ea580c;
        --error-color: #dc2626;
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --text-color: #e2e8f0;
        --border-color: #334155;
        --spacing: 1rem;
        --safe-top: max(1rem, env(safe-area-inset-top));
        --safe-bottom: max(1rem, env(safe-area-inset-bottom));
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -webkit-touch-callout: none;
      }

      /* Dark mode auto-detection */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-color: #0f172a;
          --card-bg: #1e293b;
          --text-color: #e2e8f0;
        }
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg-color: #f8fafc;
          --card-bg: #f1f5f9;
          --text-color: #1e293b;
          --border-color: #cbd5e1;
        }
      }

      .container {
        max-width: 100%;
        overflow-x: hidden;
        padding-top: var(--safe-top);
        padding-bottom: calc(80px + var(--safe-bottom));
      }

      /* Header */
      .header {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem var(--spacing);
        position: sticky;
        top: 0;
        z-index: 30;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
      }

      .header-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Status indicator */
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .status-online {
        background-color: var(--success-color);
      }

      .status-offline {
        background-color: #6b7280;
      }

      .status-warning {
        background-color: var(--warning-color);
      }

      /* Responsive grid */
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing);
        padding: var(--spacing);
      }

      @media (min-width: 640px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (min-width: 1280px) {
        .grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      /* Card styles */
      .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease;
        overflow: hidden;
      }

      .card:active {
        transform: scale(0.98);
      }

      @media (prefers-reduced-motion: reduce) {
        .card {
          transition: none;
        }
      }

      .card h2 {
        font-size: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
      }

      .card h3 {
        font-size: 0.875rem;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
        font-weight: 600;
      }

      /* Metric rows */
      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.875rem;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-label {
        font-weight: 500;
        color: #94a3b8;
      }

      .metric-value {
        color: var(--primary-color);
        font-weight: 600;
      }

      /* Status badge */
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: rgba(37, 99, 235, 0.2);
        color: var(--primary-color);
      }

      .status-badge.online {
        background-color: rgba(22, 163, 74, 0.2);
        color: var(--success-color);
      }

      .status-badge.offline {
        background-color: rgba(107, 114, 128, 0.2);
        color: #6b7280;
      }

      /* Buttons */
      button {
        min-height: 48px;
        min-width: 48px;
        padding: 0.75rem 1rem;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        user-select: none;
      }

      button:active {
        background-color: #1d4ed8;
        transform: scale(0.95);
      }

      @media (prefers-reduced-motion: reduce) {
        button {
          transition: none;
        }
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background-color: transparent;
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:active {
        background-color: rgba(37, 99, 235, 0.1);
        border-color: var(--primary-color);
      }

      .btn-success {
        background-color: var(--success-color);
      }

      .btn-success:active {
        background-color: #15803d;
      }

      .btn-danger {
        background-color: var(--error-color);
      }

      .btn-danger:active {
        background-color: #b91c1c;
      }

      /* Health bar */
      .health-bar {
        width: 100%;
        height: 6px;
        background-color: var(--border-color);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .health-fill {
        height: 100%;
        background-color: var(--success-color);
        width: 0%;
        transition: width 0.3s ease;
      }

      .health-fill.warning {
        background-color: var(--warning-color);
      }

      .health-fill.error {
        background-color: var(--error-color);
      }

      /* Alert items */
      .alert-item {
        background-color: transparent;
        border-left: 3px solid var(--warning-color);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
      }

      .alert-item.error {
        border-left-color: var(--error-color);
      }

      .alert-item.success {
        border-left-color: var(--success-color);
      }

      .alert-item.info {
        border-left-color: var(--primary-color);
      }

      .alert-type {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
      }

      .alert-message {
        font-size: 0.875rem;
      }

      .alert-time {
        color: #94a3b8;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }

      /* Loader */
      .spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #94a3b8;
      }

      .no-data {
        text-align: center;
        color: #94a3b8;
        padding: 1.5rem;
        font-size: 0.875rem;
      }

      /* Bottom navigation */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background-color: var(--card-bg);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 40;
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
        gap: 0.5rem;
      }

      .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.5rem;
        color: #94a3b8;
        cursor: pointer;
        user-select: none;
        min-height: 48px;
        border-radius: 0.375rem;
        transition: all 0.2s;
      }

      .nav-item:active {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
      }

      .nav-item.active {
        color: var(--primary-color);
      }

      .nav-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-label {
        font-size: 0.65rem;
        font-weight: 600;
        text-align: center;
      }

      /* Quick action buttons */
      .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        padding: var(--spacing);
      }

      .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 100px;
        text-align: center;
        text-decoration: none;
        color: var(--text-color);
        user-select: none;
      }

      .quick-action:active {
        background-color: var(--primary-color);
        color: white;
      }

      .quick-action-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .quick-action-label {
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* Agent cards */
      .agent-card {
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
      }

      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
      }

      .agent-name {
        font-weight: 600;
        font-size: 0.875rem;
      }

      .agent-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.75rem;
      }

      .stat {
        padding: 0.25rem;
      }

      .stat-label {
        color: #94a3b8;
      }

      .stat-value {
        color: var(--primary-color);
        font-weight: 600;
      }

      /* Timestamp */
      .timestamp {
        font-size: 0.75rem;
        color: #94a3b8;
        padding: var(--spacing);
        text-align: center;
        border-top: 1px solid var(--border-color);
      }

      /* Tab content */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 50;
        padding: var(--safe-top) var(--spacing) var(--safe-bottom);
        overflow-y: auto;
      }

      .modal.open {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 90vw;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
      }

      /* Gesture feedback */
      .swipe-hint {
        font-size: 0.75rem;
        color: #94a3b8;
        text-align: center;
        padding: 0.5rem;
        display: none;
      }

      /* Reduce motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Landscape mode adjustments */
      @media (max-height: 500px) {
        .bottom-nav {
          height: 60px;
          padding-bottom: 0;
        }

        .container {
          padding-bottom: calc(60px + var(--safe-bottom));
        }

        .header h1 {
          font-size: 1.25rem;
        }

        .card {
          padding: 0.75rem;
        }

        .grid {
          gap: 0.5rem;
          padding: 0.5rem;
        }
      }

      /* Print media */
      @media print {
        .bottom-nav,
        .header {
          display: none;
        }

        .container {
          padding-bottom: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1>üîç OpenClaw</h1>
      <div style="display: flex; gap: 0.5rem; align-items: center">
        <span class="status-indicator status-online"></span>
        <button
          class="btn-secondary"
          onclick="refreshDashboard()"
          style="min-width: 40px; padding: 0.5rem"
        >
          ‚ü≥
        </button>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Dashboard Tab -->
      <div id="dashboard-tab" class="tab-content active">
        <!-- System Health -->
        <div class="grid">
          <div class="card">
            <h2>System Health</h2>
            <div class="metric">
              <span class="metric-label">Status</span>
              <span class="metric-value" id="system-status">‚óè</span>
            </div>
            <div class="metric">
              <span class="metric-label">Memory</span>
              <span class="metric-value" id="memory-usage">-</span>
            </div>
            <div class="health-bar">
              <div class="health-fill" id="memory-bar"></div>
            </div>
            <div class="metric">
              <span class="metric-label">Uptime</span>
              <span class="metric-value" id="uptime">-</span>
            </div>
            <div class="metric">
              <span class="metric-label">Tasks</span>
              <span class="metric-value" id="active-tasks">0</span>
            </div>
          </div>

          <!-- Cost Summary -->
          <div class="card">
            <h2>üí∞ Costs</h2>
            <div class="metric">
              <span class="metric-label">Today</span>
              <span class="metric-value" id="cost-today">$0.00</span>
            </div>
            <div class="metric">
              <span class="metric-label">Week</span>
              <span class="metric-value" id="cost-week">$0.00</span>
            </div>
            <div class="metric">
              <span class="metric-label">Month</span>
              <span class="metric-value" id="cost-month">$0.00</span>
            </div>
            <div class="metric">
              <span class="metric-label">Rate</span>
              <span class="metric-value" id="cost-rate">$0.00/day</span>
            </div>
          </div>

          <!-- Today's Metrics -->
          <div class="card">
            <h2>üìä Today</h2>
            <div class="metric">
              <span class="metric-label">Tasks</span>
              <span class="metric-value" id="metric-today-tasks">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Response</span>
              <span class="metric-value" id="metric-today-response">0s</span>
            </div>
            <div class="metric">
              <span class="metric-label">Success</span>
              <span class="metric-value" id="metric-today-success">0%</span>
            </div>
            <div class="metric">
              <span class="metric-label">Accuracy</span>
              <span class="metric-value" id="metric-today-accuracy">0%</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-action" onclick="executeAction('restart')">
            <div class="quick-action-icon">üîÑ</div>
            <div class="quick-action-label">Restart</div>
          </div>
          <div class="quick-action" onclick="switchTab('logs-tab')">
            <div class="quick-action-icon">üìã</div>
            <div class="quick-action-label">Logs</div>
          </div>
          <div class="quick-action" onclick="showModal('health-check')">
            <div class="quick-action-icon">‚úì</div>
            <div class="quick-action-label">Health</div>
          </div>
          <div class="quick-action" onclick="executeAction('scale')">
            <div class="quick-action-icon">‚ö°</div>
            <div class="quick-action-label">Scale</div>
          </div>
        </div>

        <!-- Agent Status -->
        <div style="padding: var(--spacing); padding-top: 0">
          <h2
            style="
              font-size: 1rem;
              margin-bottom: 1rem;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 0.5rem;
            "
          >
            Agents
          </h2>
          <div id="agents-container" class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
          </div>
        </div>

        <!-- Alerts -->
        <div style="padding: var(--spacing); padding-top: 0">
          <h2
            style="
              font-size: 1rem;
              margin-bottom: 1rem;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 0.5rem;
            "
          >
            üîî Alerts
          </h2>
          <div id="alerts-container" class="no-data">
            <p>No active alerts</p>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs-tab" class="tab-content">
        <div style="padding: var(--spacing)">
          <h2 style="font-size: 1rem; margin-bottom: 1rem">Live Logs</h2>
          <div
            style="
              background-color: var(--bg-color);
              border: 1px solid var(--border-color);
              border-radius: 0.5rem;
              padding: 1rem;
              font-family: monospace;
              font-size: 0.75rem;
              max-height: 400px;
              overflow-y: auto;
              line-height: 1.4;
            "
          >
            <div
              id="logsContainer"
              style="color: #94a3b8; word-break: break-all; white-space: pre-wrap"
            >
              <div><span style="color: var(--success-color)">[13:45:23]</span> Gateway started</div>
              <div>
                <span style="color: var(--primary-color)">[13:45:24]</span> Tunnel connected
              </div>
              <div>
                <span style="color: var(--success-color)">[13:45:25]</span> Telegram bot ready
              </div>
            </div>
          </div>
          <button onclick="clearLogs()" class="btn-secondary" style="margin-top: 1rem; width: 100%">
            Clear Logs
          </button>
        </div>
      </div>

      <div class="timestamp">Last updated: <span id="last-update">-</span></div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('dashboard-tab')">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">Status</div>
      </div>
      <div class="nav-item" onclick="switchTab('logs-tab')">
        <div class="nav-icon">üìã</div>
        <div class="nav-label">Logs</div>
      </div>
      <div class="nav-item" onclick="showModal('settings-modal')">
        <div class="nav-icon">‚öôÔ∏è</div>
        <div class="nav-label">More</div>
      </div>
    </div>

    <!-- Health Check Modal -->
    <div id="health-check" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Health Check</h3>
          <button class="modal-close" onclick="closeModal('health-check')">‚úï</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.75rem">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 0.75rem;
              background-color: var(--bg-color);
              border-radius: 0.375rem;
            "
          >
            <span style="color: #94a3b8">API Connectivity</span>
            <span style="color: var(--success-color); font-weight: 600">OK</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 0.75rem;
              background-color: var(--bg-color);
              border-radius: 0.375rem;
            "
          >
            <span style="color: #94a3b8">Database</span>
            <span style="color: var(--success-color); font-weight: 600">OK</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 0.75rem;
              background-color: var(--bg-color);
              border-radius: 0.375rem;
            "
          >
            <span style="color: #94a3b8">Memory</span>
            <span>256MB / 512MB</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 0.75rem;
              background-color: var(--bg-color);
              border-radius: 0.375rem;
            "
          >
            <span style="color: #94a3b8">CPU</span>
            <span>12%</span>
          </div>
        </div>
        <button
          onclick="closeModal('health-check')"
          class="btn-primary"
          style="margin-top: 1.5rem; width: 100%"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Options</h3>
          <button class="modal-close" onclick="closeModal('settings-modal')">‚úï</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.5rem">
          <button onclick="executeAction('restart')" class="btn-primary" style="width: 100%">
            üîÑ Restart Gateway
          </button>
          <button onclick="executeAction('scale')" class="btn-success" style="width: 100%">
            ‚ö° Scale to 3 Instances
          </button>
          <button onclick="showModal('reset-confirm')" class="btn-danger" style="width: 100%">
            ‚ö†Ô∏è Reset Gateway
          </button>
          <button onclick="closeModal('settings-modal')" class="btn-secondary" style="width: 100%">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" style="color: var(--error-color)">Reset Gateway?</h3>
          <button class="modal-close" onclick="closeModal('reset-confirm')">‚úï</button>
        </div>
        <p style="margin-bottom: 1.5rem; color: #94a3b8">
          This will clear all sessions and restart. Cannot be undone.
        </p>
        <div style="display: flex; gap: 0.5rem">
          <button onclick="closeModal('reset-confirm')" class="btn-secondary" style="flex: 1">
            Cancel
          </button>
          <button onclick="executeAction('reset-gateway')" class="btn-danger" style="flex: 1">
            Reset
          </button>
        </div>
      </div>
    </div>

    <script>
      // Feature detection for progressive enhancement
      const hasLocalStorage = () => {
        try {
          const test = "__test__";
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      };

      const hasServiceWorker = () => "serviceWorker" in navigator;

      // Initialize service worker for offline support (optional)
      if (hasServiceWorker()) {
        navigator.serviceWorker
          .register(
            'data:application/javascript,self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("activate",e=>e.waitUntil(clients.claim()));',
          )
          .catch(() => {});
      }

      // API configuration
      const API_BASE = window.location.origin;
      const REFRESH_INTERVAL = 2000;
      const DARK_MODE =
        window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;

      // State
      let currentTab = "dashboard-tab";
      let touchStartX = 0;
      let touchStartY = 0;

      // Tab switching
      function switchTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });

        const tabElement = document.getElementById(tabName);
        if (tabElement) {
          tabElement.classList.add("active");
          currentTab = tabName;

          // Mark nav item as active
          const navItems = document.querySelectorAll(".nav-item");
          navItems.forEach((item, index) => {
            if (
              (index === 0 && tabName === "dashboard-tab") ||
              (index === 1 && tabName === "logs-tab")
            ) {
              item.classList.add("active");
            }
          });

          // Scroll to top
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      }

      // Modal functions
      function showModal(modalId) {
        document.getElementById(modalId).classList.add("open");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("open");
      }

      // Close modal on background click
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.remove("open");
          }
        });
      });

      // Fetch and update dashboard
      async function fetchDashboard() {
        try {
          const response = await fetch(`${API_BASE}/api/monitoring/state`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const json = await response.json();
          if (json.success) {
            updateDashboard(json.data);
          }
        } catch (err) {
          console.error("Failed to fetch dashboard:", err);
          // Gracefully degrade - show cached data or placeholder
          document.getElementById("system-status").textContent = "‚ö†Ô∏è Offline";
        }
      }

      function updateDashboard(state) {
        updateSystemHealth(state.system_health);
        updateAgents(state.agents);
        updateCosts(state.costs);
        updateMetrics(state.metrics);
        updateAlerts(state.alerts);
        document.getElementById("last-update").textContent = new Date(
          state.timestamp,
        ).toLocaleTimeString();
      }

      function updateSystemHealth(health) {
        const memory = health.memory_usage_percent;
        document.getElementById("memory-usage").textContent = `${memory}%`;
        document.getElementById("uptime").textContent = `${Math.floor(health.uptime_hours)}h`;
        document.getElementById("active-tasks").textContent = health.active_tasks;

        const memoryBar = document.getElementById("memory-bar");
        memoryBar.style.width = `${Math.min(100, memory)}%`;

        if (memory > 80) {
          memoryBar.classList.add("error");
          memoryBar.classList.remove("warning");
        } else if (memory > 60) {
          memoryBar.classList.add("warning");
          memoryBar.classList.remove("error");
        } else {
          memoryBar.classList.remove("warning", "error");
        }

        const status =
          memory < 90 && health.active_tasks < 50
            ? "üü¢ Healthy"
            : memory > 90
              ? "üî¥ Critical"
              : "üü° Busy";
        document.getElementById("system-status").textContent = status;
      }

      function updateAgents(agents) {
        const container = document.getElementById("agents-container");
        if (agents.length === 0) {
          container.innerHTML = '<p class="no-data">No agents</p>';
          return;
        }

        container.innerHTML = agents
          .map(
            (agent) => `
          <div class="agent-card">
            <div class="agent-header">
              <span class="agent-name">${agent.name}</span>
              <span class="status-badge ${agent.status === "online" ? "online" : "offline"}">${agent.status.toUpperCase()}</span>
            </div>
            <div class="agent-stats">
              <div class="stat">
                <div class="stat-label">Tasks</div>
                <div class="stat-value">${agent.task_count}</div>
              </div>
              <div class="stat">
                <div class="stat-label">Success</div>
                <div class="stat-value">${agent.success_count}</div>
              </div>
              <div class="stat">
                <div class="stat-label">Errors</div>
                <div class="stat-value">${agent.error_count}</div>
              </div>
              <div class="stat">
                <div class="stat-label">Uptime</div>
                <div class="stat-value">${Math.floor(agent.uptime_seconds / 60)}m</div>
              </div>
            </div>
          </div>
        `,
          )
          .join("");
      }

      function updateCosts(costs) {
        document.getElementById("cost-today").textContent = `$${costs.today.toFixed(2)}`;
        document.getElementById("cost-week").textContent = `$${costs.this_week.toFixed(2)}`;
        document.getElementById("cost-month").textContent = `$${costs.this_month.toFixed(2)}`;
        document.getElementById("cost-rate").textContent = `$${costs.daily_rate.toFixed(2)}/day`;
      }

      function updateMetrics(metrics) {
        const today = metrics.today;
        document.getElementById("metric-today-tasks").textContent = today.total_tasks;
        document.getElementById("metric-today-response").textContent =
          `${today.avg_response_time_seconds.toFixed(2)}s`;
        document.getElementById("metric-today-success").textContent =
          `${today.success_rate.toFixed(1)}%`;
        document.getElementById("metric-today-accuracy").textContent =
          `${today.avg_accuracy_score.toFixed(1)}%`;
      }

      function updateAlerts(alerts) {
        const container = document.getElementById("alerts-container");
        if (alerts.length === 0) {
          container.innerHTML = '<p class="no-data">No alerts</p>';
          return;
        }

        container.innerHTML = alerts
          .slice(0, 5)
          .map(
            (alert) => `
          <div class="alert-item ${alert.type}">
            <div class="alert-type">${alert.type}</div>
            <div class="alert-message">${alert.message}</div>
            <div class="alert-time">${new Date(alert.timestamp).toLocaleTimeString()}</div>
          </div>
        `,
          )
          .join("");
      }

      function executeAction(action) {
        const messages = {
          restart: "Gateway restart initiated...",
          scale: "Scaling to 3 instances...",
          "reset-gateway": "Gateway reset initiated...",
        };

        const msg = messages[action] || `Action: ${action}`;
        showNotification(msg);
      }

      function showNotification(message) {
        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          bottom: 100px;
          left: 50%;
          transform: translateX(-50%);
          background-color: var(--card-bg);
          color: var(--text-color);
          padding: 1rem 1.5rem;
          border-radius: 0.5rem;
          border: 1px solid var(--border-color);
          z-index: 100;
          font-size: 0.875rem;
          max-width: 90%;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      function clearLogs() {
        document.getElementById("logsContainer").innerHTML =
          '<div style="color: #94a3b8;">Logs cleared</div>';
        showNotification("Logs cleared");
      }

      function refreshDashboard() {
        fetchDashboard();
        showNotification("Refreshing...");
      }

      // Swipe gesture support
      document.addEventListener(
        "touchstart",
        (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        },
        { passive: true },
      );

      document.addEventListener(
        "touchend",
        (e) => {
          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;
          const deltaX = touchEndX - touchStartX;
          const deltaY = touchEndY - touchStartY;

          if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0 && currentTab === "logs-tab") {
              switchTab("dashboard-tab");
            } else if (deltaX < 0 && currentTab === "dashboard-tab") {
              switchTab("logs-tab");
            }
          }
        },
        { passive: true },
      );

      // Initial load and polling
      fetchDashboard();
      const refreshIntervalId = setInterval(fetchDashboard, REFRESH_INTERVAL);

      // Cleanup on unload
      window.addEventListener("beforeunload", () => {
        clearInterval(refreshIntervalId);
      });

      // Auto-detect dark mode changes
      if (window.matchMedia) {
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
          document.documentElement.style.colorScheme = e.matches ? "dark" : "light";
        });
      }

      // Prevent accidental zoom on input
      document.addEventListener("gesturestart", (e) => {
        e.preventDefault();
      });
    </script>
  </body>
</html>
